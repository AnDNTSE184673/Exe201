-- Tạo database và chọn context
CREATE DATABASE NutritionApp;
GO
USE NutritionApp;
GO

-- Bảng Role (Free, Premium, Admin)
CREATE TABLE Role (
    RoleId INT IDENTITY PRIMARY KEY,
    RoleName NVARCHAR(50) NOT NULL UNIQUE -- Free, Premium, Admin
);

-- Bảng User
CREATE TABLE [User] (
    UserId INT IDENTITY PRIMARY KEY,
    Email NVARCHAR(100) NOT NULL UNIQUE,
    PasswordHash NVARCHAR(255) NOT NULL,
    FullName NVARCHAR(100),
    AvatarUrl NVARCHAR(255),
    DateOfBirth DATE,
    IsGoogle BIT NOT NULL DEFAULT 0, -- true nếu login bằng Google
    RoleId INT NOT NULL, -- Free / Premium / Admin
    TermsAcceptedAt DATETIME NOT NULL DEFAULT GETDATE(),
    PremiumExpiry DATETIME NULL, -- ngày hết hạn gói premium
    IsActive BIT NOT NULL DEFAULT 1,
    CreatedAt DATETIME NOT NULL DEFAULT GETDATE(),
    UpdatedAt DATETIME NULL,
    FOREIGN KEY(RoleId) REFERENCES Role(RoleId)
);

-- Bảng PremiumPackage (gói dịch vụ trả phí)
CREATE TABLE PremiumPackage (
    PackageId INT IDENTITY PRIMARY KEY,
    PackageName NVARCHAR(100) NOT NULL,
    Description NVARCHAR(500),
    Price DECIMAL(10,2) NOT NULL,
    DurationDays INT NOT NULL -- số ngày kích hoạt gói
);

-- Bảng PaymentMethod (phương thức thanh toán)
CREATE TABLE PaymentMethod (
    PaymentMethodId INT IDENTITY PRIMARY KEY,
    MethodName NVARCHAR(50) NOT NULL -- VNPAY, MoMo, ApplePay...
);

-- Bảng Transaction (lịch sử thanh toán)
CREATE TABLE [Transaction] (
    TransactionId INT IDENTITY PRIMARY KEY,
    UserId INT NOT NULL,
    PackageId INT NOT NULL,
    PaymentMethodId INT NOT NULL,
    TransactionCode NVARCHAR(100) NOT NULL UNIQUE,
    Amount DECIMAL(10,2) NOT NULL,
    Status NVARCHAR(50) NOT NULL, -- Success, Failed, Pending
    PurchasedAt DATETIME NOT NULL DEFAULT GETDATE(),
    FOREIGN KEY(UserId) REFERENCES [User](UserId),
    FOREIGN KEY(PackageId) REFERENCES PremiumPackage(PackageId),
    FOREIGN KEY(PaymentMethodId) REFERENCES PaymentMethod(PaymentMethodId)
);
-- Role
INSERT INTO Role (RoleName) VALUES 
('Free'),
('Premium'),
('Admin');

-- User
INSERT INTO [User] (Email, PasswordHash, FullName, AvatarUrl, DateOfBirth, IsGoogle, RoleId, TermsAcceptedAt, PremiumExpiry)
VALUES
('user1@example.com', 'hashed_pwd_123', 'Nguyễn Văn A', NULL, '1995-04-10', 0, 1, GETDATE(), NULL), -- Free
('user2@example.com', 'hashed_pwd_456', 'Trần Thị B', NULL, '1990-08-15', 1, 2, GETDATE(), DATEADD(DAY, 30, GETDATE())), -- Premium
('admin@example.com', 'admin_hashed_pwd', 'Admin C', NULL, '1985-01-01', 0, 3, GETDATE(), NULL); -- Admin

-- PremiumPackage
INSERT INTO PremiumPackage (PackageName, Description, Price, DurationDays) VALUES
('Gói 30 Ngày', N'Tư vấn dinh dưỡng đầy đủ trong 30 ngày', 99000, 30),
('Gói 90 Ngày', N'Tư vấn dinh dưỡng và theo dõi sức khỏe trong 90 ngày', 249000, 90);

-- PaymentMethod
INSERT INTO PaymentMethod (MethodName) VALUES 
('Banking'),
('MoMo'),
('Banking');

-- Transaction
INSERT INTO [Transaction] (UserId, PackageId, PaymentMethodId, TransactionCode, Amount, Status, PurchasedAt)
VALUES
(2, 1, 1, 'TXN001', 99000, 'Success', GETDATE()), -- user2 mua Gói 30 ngày bằng VNPAY
(2, 2, 2, 'TXN002', 249000, 'Pending', GETDATE()); -- user2 thử mua Gói 90 ngày bằng MoMo
